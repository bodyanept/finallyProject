<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}ZapChasti{% endblock %}</title>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Tailwind theme tweak (Wildberries-like purple)
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                500: '#8e2de2', // purple
                600: '#6a11cb', // darker
                700: '#5b0eb3',
              }
            }
          }
        }
      }
    </script>
    <script>
      // Setup CSRF for HTMX
      (function(){
        function getCookie(name){
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(';').shift();
        }
        window.getCSRFToken = function(){ return getCookie('csrftoken') || ''; }
        document.addEventListener('htmx:configRequest', (event) => {
          const token = getCookie('csrftoken');
          if (token) event.detail.headers['X-CSRFToken'] = token;
          // Do not force Content-Type here; let HTMX send form-encoded by default
        });
        // Simple fetch helpers
        window.refreshCartBadge = async function(){
          try {
            const res = await fetch('/api/cart/');
            if (!res.ok) return;
            const data = await res.json();
            const count = (data.items || []).reduce((a, i) => a + (i.quantity||0), 0);
            const badge = document.getElementById('cart-badge');
            if (badge) badge.textContent = String(count);
          } catch (e) { /* noop */ }
        }
        window.addToCart = async function(productId, qty=1){
          try {
            const token = getCookie('csrftoken');
            await fetch('/api/cart/items/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': token || ''
              },
              body: JSON.stringify({product: productId, quantity: qty})
            });
            await window.refreshCartBadge();
          } catch (e) { /* noop */ }
        }
        document.addEventListener('DOMContentLoaded', window.refreshCartBadge);

        // Toast notifications
        window.showToast = function(message){
          const wrap = document.getElementById('toast-container');
          if (!wrap) return;
          const el = document.createElement('div');
          el.className = 'bg-slate-900 text-white/95 rounded-md px-4 py-2 shadow';
          el.textContent = message;
          wrap.appendChild(el);
          setTimeout(() => { el.classList.add('opacity-0'); el.style.transition='opacity .3s'; }, 2000);
          setTimeout(() => { el.remove(); }, 2300);
        }

        // Mini-cart open/close
        function setupMiniCart(){
          const link = document.getElementById('cart-link');
          const panel = document.getElementById('mini-cart');
          if (!link || !panel) return;
          async function loadMini(){
            try {
              const res = await fetch('/mini-cart/');
              panel.innerHTML = await res.text();
            } catch(e) { panel.innerHTML = '<div class="p-4">Ошибка загрузки</div>'; }
          }
          function open(){ panel.classList.remove('hidden'); }
          function close(){ panel.classList.add('hidden'); }
          link.addEventListener('click', async (e) => {
            // Ctrl/cmd click opens new tab normally
            if (e.ctrlKey || e.metaKey) return;
            e.preventDefault();
            await loadMini();
            open();
          });
          document.addEventListener('click', (e) => {
            if (!panel.classList.contains('hidden')){
              const nav = document.getElementById('main-nav');
              if (!panel.contains(e.target) && !nav.contains(e.target)) close();
            }
          });
          // Update mini-cart after HTMX cart add
          document.body.addEventListener('htmx:afterRequest', async (ev) => {
            const target = ev.target;
            if (target && target.getAttribute && target.getAttribute('hx-post') === '/api/cart/items/'){
              showToast('Товар добавлен в корзину');
              await window.refreshCartBadge();
              // refresh mini if open
              if (!panel.classList.contains('hidden')){ await loadMini(); }
            }
          });
        }
        document.addEventListener('DOMContentLoaded', setupMiniCart);
      })();
    </script>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <header class="bg-gradient-to-r from-brand-600 to-brand-500 text-white">
      <div class="max-w-7xl mx-auto px-4 py-4">
        <div class="flex items-center gap-4">
          <a href="/" class="text-2xl font-semibold tracking-tight">ZapChasti</a>
          <form action="/catalog/" method="get" class="flex-1">
            <input type="hidden" name="goto" value="1" />
            <input name="search" type="search" placeholder="Искать запчасти, артикул, производитель"
                   class="w-full rounded-md px-4 py-2 text-slate-900 focus:outline-none focus:ring-2 focus:ring-white/60" />
          </form>
          <nav class="flex items-center gap-4 text-sm" id="main-nav">
            <a class="hover:underline" href="/catalog/">Каталог</a>
            {% if request.user.is_authenticated %}
              <a class="hover:underline" href="/account/">Кабинет</a>
              <a class="hover:underline" href="/logout/">Выйти</a>
            {% else %}
              <a class="hover:underline" href="/login/">Войти</a>
            {% endif %}
            <a class="relative font-medium" href="/cart/" id="cart-link">
              Корзина
              <span id="cart-badge" class="ml-1 inline-flex items-center justify-center text-xs bg-white/90 text-brand-700 rounded-full px-2 py-0.5">0</span>
            </a>
          </nav>
        </div>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-8">
      {% if messages %}
        <div class="space-y-2 mb-6">
          {% for message in messages %}
            <div class="px-4 py-2 rounded-md border bg-white text-sm">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
      {% block content %}{% endblock %}
    </main>

    <!-- Emit CSRF cookie -->
    <form class="hidden">{% csrf_token %}</form>

    <!-- Mini-cart dropdown -->
    <div id="mini-cart" class="hidden fixed right-4 top-20 z-50 w-96 max-h-[70vh] overflow-auto rounded-xl border bg-white shadow-xl"></div>

    <!-- Toast container -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 space-y-2"></div>

    <footer class="py-8 text-center text-xs text-slate-500">
      Учебный проект. Оплаты — имитация. {{ request.path }}
    </footer>
    {% block extra_js %}{% endblock %}
  </body>
</html>
